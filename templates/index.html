<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sofia">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin:ital,wght@0,400..700;1,400..700&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Varela+Round&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <title>MetaHacks</title>

</head>
<body>

<ul class="tabs">
    <li data-tab-target="#home" class="active tab"><i class="fa-solid fa-house"></i></li>
    <li data-tab-target="#course1" class="tab">MATH 115</li>
    <li data-tab-target="#course2" class="tab">MATH 117</li>
    <li data-tab-target="#course3" class="tab">ECE 150</li>
    <li data-tab-target="#course4" class="tab">ECE 105</li>
    <li data-tab-target="#course5" class="tab">ENG 101</li>
</ul>

<div class="tab-content">
    <div id="home" data-tab-content class="active" data-tab-name="HOME">
        <h1>Evaluate the integral âˆ« (2x + 5) dx...</h1>
    </div>
    <div id="course1" data-tab-content data-tab-name="math115">
        <h1>Math 115 Content</h1>
        <div id="response-container">
            <p id="response">Result will be displayed here after recording.</p>
        </div>
        <button class="recordButton"><i class="fa-solid fa-microphone"></i></button>
    </div>
    <div id="course2" data-tab-content data-tab-name="course2">
        <h1>Course 2 Content</h1>
        <button class="recordButton"><i class="fa-solid fa-microphone"></i></button>
    </div>
    <div id="course3" data-tab-content data-tab-name="course3">
        <h1>Course 3 Content</h1>
        <button class="recordButton"><i class="fa-solid fa-microphone"></i></button>
    </div>
    <div id="course4" data-tab-content data-tab-name="course4">
        <h1>Course 4 Content</h1>
        <button class="recordButton"><i class="fa-solid fa-microphone"></i></button>
    </div>
    <div id="course5" data-tab-content data-tab-name="course5">
        <h1>Course 5 Content</h1>
        <button class="recordButton"><i class="fa-solid fa-microphone"></i></button>
    </div>
</div>
<script>
    const tabs = document.querySelectorAll("[data-tab-target]")
    const tabContents = document.querySelectorAll("[data-tab-content]")

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            const target = document.querySelector(tab.dataset.tabTarget)
            tabContents.forEach(tabContent => {
                tabContent.classList.remove("active")
            })
            tabs.forEach(tab => {
                tab.classList.remove("active")
            })
            tab.classList.add("active")
            target.classList.add("active")
        })
    })

    document.querySelectorAll(".recordButton").forEach(button => {
        button.addEventListener("click", async () => {
            const parentTab = button.closest("[data-tab-content]");
            const tabName = parentTab ? parentTab.getAttribute("data-tab-name") || "Recording" : "Recording";

            // Check if the button is already recording
            if (button.classList.contains("recording")) {
                // Stop the recording
                mediaRecorder.stop();
                button.classList.remove("recording");
                return;
            }

            // Start a new recording
            button.classList.add("recording");

            // Request a new audio stream for each recording
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioChunks = [];
            const mediaRecorder = new MediaRecorder(stream);

            // Collect audio data
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

            // Save the file when recording stops
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: "audio/wav" });
                /*
                const url = URL.createObjectURL(blob);

                // Suggest a folder name in the filename
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = `${tabName}.wav`; // Suggest folder structure in the filename
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);*/
                testSendtoBackend(blob, tabName);
            };

            // Start recording
            mediaRecorder.start();

            // Stop the stream and cleanup if the tab changes
            button.addEventListener("click", () => {
                if (mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    button.classList.remove("recording");
                }
                stream.getTracks().forEach(track => track.stop()); // Stop the stream
            }, { once: true });
        });
    });

    async function testSendtoBackend(audioBlob, tabName) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
            
        try {
            const response = await fetch("/to_back/".concat(tabName), {
                method: "POST",
                body: formData
            });
            const result = await response.text();

            // Update the HTML with the result
            const responseContainer = document.getElementById("response");
            responseContainer.textContent = `Backend Response: ${result}`;
        } catch (error) {
            // Display an error message in the HTML
            const responseContainer = document.getElementById("response");
            responseContainer.textContent = `Error: ${error.message}`;
        }
    }

</script>
</body>
</html>